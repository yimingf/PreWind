<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>wind map</title>

<script src='https://d3js.org/d3.v3.min.js' charset='utf-8'></script>
<script src='https://d3js.org/topojson.v1.min.js'></script>

<style type='text/css'>
  .feature {
    fill: lightblue;
    stroke: grey;
    stroke-width: 1px;
    stroke-linejoin: round;
  }
  .feature:hover {
    fill : #adccff;
  }
  .mesh {
    fill: none;
    stroke: lightpink;
    stroke-width: 2px;
    stroke-linejoin: round;
  }
  h1 {
    font-family: courier;
  }
  .hidden {
    display: none;
  }
  div.tooltip {
    color: #222;
    background-color: #fff;
    padding: .5em;
    text-shadow: #f5f5f5 0 1px 0;
    border-radius: 2px;
    opacity: 0.9;
    position: absolute;
  }
</style>
</head>
<body>
  <h1>european wind map.</h1>

<script type='text/javascript'>

var width = 1280,
  height = 800;
var projection = d3.geo.mercator();
var path = d3.geo.path()
  .projection(projection);

var svg = d3.select('body').append('svg')
  .attr('id', 'foo')
  .attr('width', width)
  .attr('height', height);

function animation(selection) {
  let real_pixels = (_, i) => projection([
    i-Math.floor((i+9360)/360),
    90-Math.floor((i+9360)/360)
  ]);
  let real_moved_pixels = function(d, i) {
    let pixels = real_pixels(d, i);
    return [
      d[0]+pixels[0],
      d[1]+pixels[1]
  ]};

  selection
    .attr('x1', function(_, i) {
      return real_pixels(_, i)[0];
    })
    .attr('x2', function(_, i) {
      return real_pixels(_, i)[0];
    })
    .attr('y1', function(_, i) {
      return real_pixels(_, i)[1];
    })
    .attr('y2', function(_, i) {
      return real_pixels(_, i)[1];
    })
  .style('opacity', 0.5)
  .style('stroke', 'red')
  .transition()
    .ease('linear')
    .duration(1000)
    .delay(10)
    .attr('x2', function(_, i) {
      return real_moved_pixels(_, i)[0];
    })
    .attr('y2', function(_, i) {
      return real_moved_pixels(_, i)[1];
    })
  .transition()
    .duration(1000)
    .style('opacity', 0)
  .each('end', function (){
    d3.selectAll('line').call(animation);
  });
}

d3.json('https://yimingf.github.io/PreWind/data/europe.json', function (error, topo) {
  var tooltip = d3.select('body').append('div')
    .attr('class', 'hidden tooltip');

  countries = topojson.feature(topo, topo.objects.europe)
    .features;

  projection
    .scale(500)
    .center([16.09, 50.60]);

  svg.selectAll('path')
    .data(countries).enter()
    .append('path')
    .attr('class', 'feature')
    .attr('d', path);

  var mesh = topojson.mesh(topo, topo.objects.europe, (a, b) => (a != b));

  svg.append('path')
    .datum(mesh)
    .attr('class', 'mesh')
    .attr('fill', 'red')
    .attr('d', path);

  d3.json('https://yimingf.github.io/PreWind/data/wind-surface-level-toy.json', function (error, data) {
    var c = data.objects[0].data.map(function (e, i) {
      return [e, data.objects[1].data[i]];
    });

    svg.selectAll('line')
      .data(c).enter()
      .append('line')
      .call(animation);
  });

  d3.json('https://yimingf.github.io/PreWind/data/farms.json', function (error, data) {
    var len = 20;

    svg.selectAll('image')
      .data(data.objects).enter()
      .append('image')
      .attr('href', './lib/assets/img/wind-turbine.png')
      .attr('x', function (d) {
        return (projection(d.location)[0]-len/2);
      })
      .attr('y', function (d) {
        return (projection(d.location)[1]-len);
      })
      // .attr('r', '8px')
      .attr('height', len + 'px')
      .attr('width', len + 'px')
      .on('mousemove', function (d) {
        var mouse = d3.mouse(svg.node()).map(function (d) {
          return parseInt(d);
        });
        tooltip.classed('hidden', false)
          .attr('style', 'left:' + (mouse[0] + 15) +
            'px; top:' + (mouse[1] - 35) + 'px')
          .html(function () {
            return 'name: ' + d.name + '<br>location: (' + d.location[0] + ', ' + d.location[1] + ')<br>owner: ' + d.owner + '<br>peak performance: ' + d.peak_production;
          });
      })
      .on('mouseout', function () {
        tooltip.classed('hidden', true);
      })
      .on('click', function () {
        console.log('caonima');
      });
  });

  
});

</script>
    
</body>
</html>