<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>wind map</title>

<script src='https://d3js.org/d3.v3.min.js' charset='utf-8'></script>
<script src='https://d3js.org/topojson.v1.min.js'></script>

<style type='text/css'>
  .feature {
    fill: lightblue;
    stroke: grey;
    stroke-width: 1px;
    stroke-linejoin: round;
  }
  .feature:hover {
    fill : #adccff;
  }
  .mesh {
    fill: none;
    stroke: lightpink;
    stroke-width: 2px;
    stroke-linejoin: round;
  }
  h1 {
    font-family: courier;
  }
  .hidden {
    display: none;
  }
  div.tooltip {
    color: #222;
    background-color: #fff;
    padding: .5em;
    text-shadow: #f5f5f5 0 1px 0;
    border-radius: 2px;
    opacity: 0.9;
    position: absolute;
  }
</style>
</head>
<body>
  <h1>european wind map.</h1>

<script type='text/javascript'>

var wind_data = [{"header":{"discipline":0,"disciplineName":"Meteorological products","gribEdition":2,"gribLength":131858,"center":7,"centerName":"US National Weather Service - NCEP(WMC)","subcenter":0,"refTime":"2014-01-31T00:00:00.000Z","significanceOfRT":1,"significanceOfRTName":"Start of forecast","productStatus":0,"productStatusName":"Operational products","productType":1,"productTypeName":"Forecast products","productDefinitionTemplate":0,"productDefinitionTemplateName":"Analysis/forecast at horizontal level/layer at a point in time","parameterCategory":2,"parameterCategoryName":"Momentum","parameterNumber":2,"parameterNumberName":"U-component_of_wind","parameterUnit":"m.s-1","genProcessType":2,"genProcessTypeName":"Forecast","forecastTime":3,"surface1Type":103,"surface1TypeName":"Specified height level above ground","surface1Value":10,"surface2Type":255,"surface2TypeName":"Missing","surface2Value":0,"gridDefinitionTemplate":0,"gridDefinitionTemplateName":"Latitude_Longitude","numberPoints":65160,"shape":6,"shapeName":"Earth spherical with radius of 6,371,229.0 m","gridUnits":"degrees","resolution":48,"winds":"true","scanMode":0,"nx":360,"ny":181,"basicAngle":0,"subDivisions":0,"lo1":0,"la1":90,"lo2":359,"la2":-90,"dx":1,"dy":1},"data":[-4.76,-4.75,-4.73],"meta":{"date":"2014-01-31T03:00:00.000Z"}},{"header":{"discipline":0,"disciplineName":"Meteorological products","gribEdition":2,"gribLength":131858,"center":7,"centerName":"US National Weather Service - NCEP(WMC)","subcenter":0,"refTime":"2014-01-31T00:00:00.000Z","significanceOfRT":1,"significanceOfRTName":"Start of forecast","productStatus":0,"productStatusName":"Operational products","productType":1,"productTypeName":"Forecast products","productDefinitionTemplate":0,"productDefinitionTemplateName":"Analysis/forecast at horizontal level/layer at a point in time","parameterCategory":2,"parameterCategoryName":"Momentum","parameterNumber":3,"parameterNumberName":"V-component_of_wind","parameterUnit":"m.s-1","genProcessType":2,"genProcessTypeName":"Forecast","forecastTime":3,"surface1Type":103,"surface1TypeName":"Specified height level above ground","surface1Value":10,"surface2Type":255,"surface2TypeName":"Missing","surface2Value":0,"gridDefinitionTemplate":0,"gridDefinitionTemplateName":"Latitude_Longitude","numberPoints":65160,"shape":6,"shapeName":"Earth spherical with radius of 6,371,229.0 m","gridUnits":"degrees","resolution":48,"winds":"true","scanMode":0,"nx":360,"ny":181,"basicAngle":0,"subDivisions":0,"lo1":0,"la1":90,"lo2":359,"la2":-90,"dx":1,"dy":1},"data":[0.75,0.83,0.91],"meta":{"date":"2014-01-31T03:00:00.000Z"}}]

function getPosition(el) {
  var xPos = 0;
  var yPos = 0;
 
  while (el) {
    if (el.tagName == 'BODY') {
      // deal with browser quirks with body/window/document and page scroll
      var xScroll = el.scrollLeft || document.documentElement.scrollLeft;
      var yScroll = el.scrollTop || document.documentElement.scrollTop;
 
      xPos += (el.offsetLeft - xScroll + el.clientLeft);
      yPos += (el.offsetTop - yScroll + el.clientTop);
    } else {
      // for all other non-BODY elements
      xPos += (el.offsetLeft - el.scrollLeft + el.clientLeft);
      yPos += (el.offsetTop - el.scrollTop + el.clientTop);
    }
 
    el = el.offsetParent;
  }
  return {
    x: xPos,
    y: yPos
  };
}

function animation(selection) {
  selection
  .attr({x1: 200, x2: 200})
  .attr('y1', d => d)
  .attr('y2', d => d)
  .style('opacity', 0.5)
  .style('stroke', 'red')
  .transition()
    .ease('linear')
    .duration(1000)
    .delay(d => d*10)
    .attr('x2', 500)
  .transition()
    .duration(1000)
    .style('opacity', 0)
  .each('end', function(){
    d3.select(this).call(animation);
  });
}

var width = 1280,
  height = 800;
var projection = d3.geo.mercator();
var path = d3.geo.path()
  .projection(projection);

var svg = d3.select('body').append('svg')
  .attr('id', 'foo')
  .attr('width', width)
  .attr('height', height);

d3.json('https://yimingf.github.io/PreWind/data/europe.json', function(error, topo) {
  var tooltip = d3.select('body').append('div')
    .attr('class', 'hidden tooltip');

  countries = topojson.feature(topo, topo.objects.europe)
    .features;

  projection
    .scale(500)
    .center([16.09, 50.60]);

  svg.selectAll('path')
    .data(countries).enter()
    .append('path')
    .attr('class', 'feature')
    .attr('d', path);

  var mesh = topojson.mesh(topo, topo.objects.europe, (a, b) => (a != b));

  svg.append('path')
    .datum(mesh)
    .attr('class', 'mesh')
    .attr('fill', 'red')
    .attr('d', path);

  d3.json('https://yimingf.github.io/PreWind/data/wind-surface-level-toy.json', function(error, data) {
    console.log(data);
    var c = data[0].data.map(function (e, i) {
      return [e, data[1].data[i]];
    });
    console.log(c);

    svg.selectAll('line')
      .data(c).enter()
      .append('line')
      .call(animation);
  });

  d3.json('https://yimingf.github.io/PreWind/data/farms.json', function(error, data) {
    var len = 20;

    svg.selectAll('image')
      .data(data.objects).enter()
      .append('image')
      .attr('href', './lib/assets/img/wind-turbine.png')
      .attr('x', function(d) {
        return (projection(d.location)[0]-len/2);
      })
      .attr('y', function(d) {
        return (projection(d.location)[1]-len);
      })
      // .attr('r', '8px')
      .attr('height', len + 'px')
      .attr('width', len + 'px')
      .on('mousemove', function(d) {
        var mouse = d3.mouse(svg.node()).map(function(d) {
          return parseInt(d);
        });
        tooltip.classed('hidden', false)
          .attr('style', 'left:' + (mouse[0] + 15) +
            'px; top:' + (mouse[1] - 35) + 'px')
          .html(function() {
            return 'name: ' + d.name + '<br>location: (' + d.location[0] + ', ' + d.location[1] + ')<br>owner: ' + d.owner + '<br>peak performance: ' + d.peak_production;
          });
      })
      .on('mouseout', function() {
        tooltip.classed('hidden', true);
      })
      .on('click', function() {
        console.log('caonima');
      });
  });

  
});

</script>
    
</body>
</html>